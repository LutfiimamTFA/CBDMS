
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Function to get the user's profile data
    function getMyProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Function to get any user's profile data
    function getUserProfile(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Function to check if the user has a specific role
    function hasRole(role) {
      return isSignedIn() && getMyProfile().role == role;
    }

    // Function to check if two users are in the same company
    function isInSameCompany(otherUserId) {
        return getMyProfile().companyId == getUserProfile(otherUserId).companyId;
    }
    
    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /users/{userId} {
      // READ: You can read your own profile. Managers can read profiles of users in the same company. Super Admins can read any profile.
      allow get: if isOwner(userId) || (hasRole('Manager') && isInSameCompany(userId)) || hasRole('Super Admin');
      // LIST: Disabled for security. No one can list all users.
      allow list: if false;
      // CREATE: You can create your own user profile.
      allow create: if isOwner(userId);
      // UPDATE: You can only update your own profile.
      // A Super Admin could change roles, but that logic would be handled via a Cloud Function.
      allow update: if isOwner(userId);
      // DELETE: You can delete your own profile.
      allow delete: if isOwner(userId);
    }

    match /tasks/{taskId} {
      // READ:
      // - Super Admins can read any task.
      // - Employees can read tasks they are assigned to.
      // - Managers can read any task within their company.
      // - Clients can read any task within their company.
      allow get: if isSignedIn() &&
                    (hasRole('Super Admin') ||
                    (hasRole('Employee') && request.auth.uid in resource.data.assigneeIds) ||
                    (hasRole('Manager') && getMyProfile().companyId == resource.data.companyId) ||
                    (hasRole('Client') && getMyProfile().companyId == resource.data.companyId));
                    
      // LIST: Query access must be handled carefully on the client-side to match these rules.
      // This rule just allows the list operation to proceed, client queries must be secure.
      allow list: if isSignedIn();

      // CREATE:
      // - Employees, Managers, and Super Admins can create tasks.
      allow create: if isSignedIn() && (hasRole('Employee') || hasRole('Manager') || hasRole('Super Admin'));

      // UPDATE:
      // - Super Admins can update any task.
      // - Managers can update tasks in their company.
      // - Employees can update tasks they are assigned to.
      // - Clients can ONLY comment (This logic would be more complex, for now they can't update).
      allow update: if isSignedIn() &&
                     (hasRole('Super Admin') ||
                     (hasRole('Manager') && getMyProfile().companyId == resource.data.companyId) ||
                     (hasRole('Employee') && request.auth.uid in resource.data.assigneeIds));

      // DELETE:
      // - Only Super Admins and Managers can delete tasks.
      allow delete: if isSignedIn() && (hasRole('Super Admin') || (hasRole('Manager') && getMyProfile().companyId == resource.data.companyId));

      // --- Nested Time Tracking ---
      match /timeTracking/{timeTrackingId} {
        // Only the assigned employee or a manager in the same company can CRUD time tracking.
        allow read, write: if isSignedIn() &&
                             (hasRole('Super Admin') ||
                             (hasRole('Manager') && getMyProfile().companyId == get(/databases/$(database)/documents/tasks/$(taskId)).data.companyId) ||
                             (isOwner(get(/databases/$(database)/documents/tasks/$(taskId)).data.assigneeIds[0]))); // Simplified for now
      }
    }
  }
}

    