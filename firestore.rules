
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --------------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Function to get any user's profile data
    function getUserProfile(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data;
    }

    // Function to check if the user has a specific role by reading THEIR OWN profile
    function hasRole(role) {
      return isSignedIn() && getUserProfile(request.auth.uid).role == role;
    }

    // Function to check if two users are in the same company
    function isInSameCompany(otherUserId) {
        // Allow reading other user's profile only if they are in the same company
        let myCompanyId = getUserProfile(request.auth.uid).companyId;
        let otherCompanyId = getUserProfile(otherUserId).companyId;
        return myCompanyId == otherCompanyId;
    }
    
    // --------------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------------

    match /users/{userId} {
      // READ: You can read your own profile. Managers can read profiles of users in the same company. Super Admins can read any profile.
      allow get: if isOwner(userId) || (hasRole('Manager') && isInSameCompany(userId)) || hasRole('Super Admin');
      
      // LIST: Employees and Managers can list users within their own company. Super Admins can list all users.
      // This is necessary for features like assigning tasks to colleagues.
      allow list: if isSignedIn() &&
                    (
                      (hasRole('Employee') || hasRole('Manager')) &&
                      request.query.where.size() > 0 &&
                      request.query.where[0][0] == 'companyId' &&
                      request.query.where[0][1] == '==' &&
                      request.query.where[0][2] == getUserProfile(request.auth.uid).companyId
                    ) || hasRole('Super Admin');


      // CREATE: Anyone can create their own user profile document.
      // This is necessary for the sign-up flow. The user ID must match the authenticated user's ID.
      allow create: if isOwner(userId);

      // UPDATE: You can only update your own profile.
      // A Super Admin could change roles, but that logic would be handled via a Cloud Function.
      allow update: if isOwner(userId);

      // DELETE: You can delete your own profile.
      allow delete: if isOwner(userId);
    }

    match /tasks/{taskId} {
      // READ:
      // - Super Admins can read any task.
      // - Employees can read tasks they are assigned to.
      // - Managers can read any task within their company.
      // - Clients can read any task within their company.
      allow get: if isSignedIn() &&
                    (hasRole('Super Admin') ||
                    (request.auth.uid in resource.data.assigneeIds) || 
                    (hasRole('Manager') && getUserProfile(request.auth.uid).companyId == resource.data.companyId) ||
                    (hasRole('Client') && getUserProfile(request.auth.uid).companyId == resource.data.companyId));
                    
      // LIST: Query access must be handled carefully on the client-side to match these rules.
      allow list: if isSignedIn();

      // CREATE:
      // - Employees, Managers, and Super Admins can create tasks.
      // Task creator must be one of the assignees.
      allow create: if isSignedIn() && 
                     (hasRole('Employee') || hasRole('Manager') || hasRole('Super Admin')) &&
                     request.auth.uid in request.resource.data.assigneeIds;

      // UPDATE:
      // - Super Admins can update any task.
      // - Managers can update tasks in their company.
      // - Employees can update tasks they are assigned to.
      // - Clients can ONLY comment (This logic would be more complex, for now they can't update).
      allow update: if isSignedIn() &&
                     (hasRole('Super Admin') ||
                     (hasRole('Manager') && getUserProfile(request.auth.uid).companyId == resource.data.companyId) ||
                     (request.auth.uid in resource.data.assigneeIds));

      // DELETE:
      // - Only Super Admins and Managers can delete tasks.
      allow delete: if isSignedIn() && (hasRole('Super Admin') || (hasRole('Manager') && getUserProfile(request.auth.uid).companyId == resource.data.companyId));

      // --- Nested Time Tracking ---
      match /timeTracking/{timeTrackingId} {
        // Only the assigned employee or a manager in the same company can CRUD time tracking.
        allow read, write: if isSignedIn() &&
                             (hasRole('Super Admin') ||
                             (hasRole('Manager') && getUserProfile(request.auth.uid).companyId == get(/databases/$(database)/documents/tasks/$(taskId)).data.companyId) ||
                             (isOwner(get(/databases/$(database)/documents/tasks/$(taskId)).data.assigneeIds[0]))); // Simplified for now
      }
    }
  }
}
